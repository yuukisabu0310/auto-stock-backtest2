# 新しいバックテスト方針ガイド

## 概要

このシステムは、指数別のランダム抽出によるバックテストを複数回実行し、結果を蓄積・集計する新しい方針を採用しています。

## バックテスト方針

### 対象データ
- **S&P500**: 米国大型株500銘柄
- **NASDAQ100**: 米国ハイテク株100銘柄
- **日経225**: 日本大型株225銘柄

### 銘柄抽出方法

#### スイングトレード戦略
- 各指数からランダムに25銘柄ずつ抽出
- 合計75銘柄（3指数 × 25銘柄）

#### 中長期投資戦略
- 各指数からランダムに50銘柄ずつ抽出
- 合計150銘柄（3指数 × 50銘柄）

### 再現性・集計
- ランダム抽出ごとに結果を保存
- 複数回の結果を蓄積
- 成績の平均値・標準偏差・分布を確認

## 自動銘柄取得機能

### 概要
- **stock_fetcher.py**: 自動銘柄取得モジュール
- **update_stocks.py**: 銘柄リスト更新スクリプト
- Wikipediaから最新の銘柄リストを自動取得

### 使用方法

#### 1. 銘柄リストの自動取得
```bash
# 全指数の銘柄を取得して新しいファイルに保存
python update_stocks.py --output index_stocks_auto.csv

# 既存ファイルとマージ
python update_stocks.py --merge

# 妥当性チェック付きで取得
python update_stocks.py --validate --merge
```

#### 2. 取得のみ実行（保存しない）
```bash
python update_stocks.py --fetch-only
```

### 取得対象
- **S&P500**: Wikipediaから最新の500銘柄
- **NASDAQ100**: Wikipediaから最新の100銘柄
- **日経225**: Wikipediaから最新の225銘柄

### 機能
- **自動取得**: Wikipediaから最新銘柄リストを取得
- **妥当性チェック**: 銘柄シンボルの形式チェック
- **重複除去**: 既存リストとの重複を自動除去
- **マージ機能**: 既存リストと新規リストの統合

## 使用方法

### 1. 指数別銘柄数の確認
```bash
python main.py --show-indices
```

### 2. 単一戦略の複数回実行
```bash
# スイングトレード戦略を5回実行
python main.py --strategy swing_trading --num-runs 5

# 中長期投資戦略を10回実行
python main.py --strategy long_term --num-runs 10
```

### 3. 全戦略の複数回実行
```bash
# 全戦略を5回ずつ実行
python main.py --num-runs 5

# 全戦略を10回ずつ実行（カスタムシード）
python main.py --num-runs 10 --base-seed 123
```

### 4. 期間指定での実行
```bash
# 特定期間で実行
python main.py --start-date 2020-01-01 --end-date 2023-12-31 --num-runs 5
```

## 出力ファイル

### 個別結果
- **保存場所**: `results/individual/`
- **ファイル形式**: JSON
- **命名規則**: `{strategy}_run_{run_id:03d}_seed_{random_seed}_{timestamp}.json`

### 集計結果
- **保存場所**: `results/aggregated/`
- **ファイル形式**: JSON
- **命名規則**: `{strategy}_aggregated_{timestamp}.json`

### サマリーレポート
- **保存場所**: `results/aggregated/`
- **ファイル形式**: HTML
- **命名規則**: `backtest_summary_{timestamp}.html`

## 結果の解釈

### 主要指標
- **total_return**: 総リターン
- **sharpe_ratio**: シャープレシオ
- **max_drawdown**: 最大ドローダウン
- **win_rate**: 勝率
- **volatility**: ボラティリティ
- **profit_factor**: プロフィットファクター

### 統計情報
- **平均値**: 複数回実行の平均
- **標準偏差**: 結果のばらつき
- **最小値・最大値**: 結果の範囲
- **中央値**: 結果の中央値
- **四分位数**: 結果の分布

### 銘柄使用頻度
- 各銘柄が何回使用されたかの統計
- 上位20銘柄の使用頻度を表示

## 再現性の確保

### 乱数シード
- ベースシード + 実行IDで各回のシードを決定
- 同じシードで実行すれば同じ銘柄セットが選択される

### 結果の保存
- 各実行の銘柄リストと結果を完全保存
- 後から再現・検証が可能

## パフォーマンス分析

### 統計的有意性
- 複数回実行により統計的有意性を確保
- ランダム性の影響を軽減

### 安定性評価
- 標準偏差による結果の安定性評価
- 外れ値の検出

### 銘柄依存性
- 銘柄使用頻度による銘柄依存性の分析
- 特定銘柄への依存度を評価

## ベストプラクティス

### 実行回数の設定
- **最小**: 5回（基本的な統計）
- **推奨**: 10-20回（より信頼性の高い結果）
- **大規模**: 50-100回（高度な統計分析）

### 期間設定
- **短期**: 1-2年（戦略の短期効果）
- **中期**: 3-5年（戦略の中期効果）
- **長期**: 5-10年（戦略の長期効果）

### 結果の解釈
- 平均値だけでなく標準偏差も確認
- 外れ値の原因を分析
- 銘柄依存性を評価

## トラブルシューティング

### よくある問題

#### 1. 銘柄データが取得できない
- **原因**: ネットワーク接続問題
- **解決**: ネットワーク環境を確認

#### 2. 実行回数が少ない
- **原因**: 統計的有意性が不足
- **解決**: 実行回数を増やす

#### 3. 結果のばらつきが大きい
- **原因**: 銘柄選択のランダム性
- **解決**: 実行回数を増やして安定性を確認

#### 4. 特定銘柄に依存
- **原因**: 銘柄プールの偏り
- **解決**: 銘柄リストの見直し

#### 5. 自動銘柄取得が失敗
- **原因**: Wikipediaの構造変更
- **解決**: 手動で銘柄リストを更新

## 拡張機能

### 将来的な拡張予定
1. **モンテカルロシミュレーション**: より高度な統計分析
2. **銘柄相関分析**: 銘柄間の相関関係分析
3. **リスク調整指標**: より詳細なリスク指標
4. **動的銘柄選択**: 期間中の銘柄変更
5. **マルチアセット**: 債券・商品などの追加
6. **定期自動更新**: 銘柄リストの定期自動更新

## サンプル実行例

### 基本的な実行
```bash
# 銘柄リストの自動更新
python update_stocks.py --merge

# 指数別銘柄数を確認
python main.py --show-indices

# スイングトレード戦略を5回実行
python main.py --strategy swing_trading --num-runs 5

# 全戦略を10回ずつ実行
python main.py --num-runs 10 --base-seed 42
```

### 結果の確認
```bash
# 個別結果の確認
ls results/individual/

# 集計結果の確認
ls results/aggregated/

# サマリーレポートの確認
open results/aggregated/backtest_summary_*.html
```

この新しいバックテスト方針により、より信頼性の高い戦略評価が可能になります。
