# 差分取得機能の詳細説明

## 概要

株価データの差分取得機能は、既存のキャッシュデータと新しい要求期間を比較し、不足している期間のデータのみを取得することで、効率的なデータ管理を実現します。

## 機能の特徴

### 1. スマートキャッシュ管理
- **既存データの活用**: 既に取得済みのデータは再利用
- **差分のみ取得**: 不足している期間のデータのみを新規取得
- **自動マージ**: 既存データと新規データを自動的に統合

### 2. 詳細なログ出力
- **要求期間の表示**: ユーザーが要求した期間
- **既存データ期間の表示**: キャッシュに保存されているデータの期間
- **不足期間の特定**: どの期間のデータが不足しているかを明確に表示
- **取得結果の報告**: 新規取得したデータの行数

## 動作例

### シナリオ1: 完全なキャッシュデータ
```
要求期間: 2024-01-01 〜 2024-01-31
既存データ期間: 2024-01-01 〜 2024-01-31
データが完全に揃っています
キャッシュから完全なデータを取得: AAPL
```

### シナリオ2: 開始期間が不足
```
要求期間: 2024-01-01 〜 2024-01-31
既存データ期間: 2024-01-02 〜 2024-01-31
開始期間が不足: 2024-01-01 〜 2024-01-01
不足期間のデータを取得: AAPL (2024-01-01 〜 2024-01-01)
```

### シナリオ3: 終了期間が不足
```
要求期間: 2024-01-01 〜 2024-12-31
既存データ期間: 2024-01-01 〜 2024-11-30
終了期間が不足: 2024-12-01 〜 2024-12-31
不足期間のデータを取得: AAPL (2024-12-01 〜 2024-12-31)
```

### シナリオ4: 開始・終了両方が不足
```
要求期間: 2024-01-01 〜 2024-12-31
既存データ期間: 2024-02-01 〜 2024-11-30
開始期間が不足: 2024-01-01 〜 2024-01-31
終了期間が不足: 2024-12-01 〜 2024-12-31
不足期間のデータを取得: AAPL (2024-01-01 〜 2024-01-31)
不足期間のデータを取得: AAPL (2024-12-01 〜 2024-12-31)
```

## 実装詳細

### 主要メソッド

#### `_get_missing_periods()`
- **目的**: 既存データと要求期間を比較して不足期間を特定
- **戻り値**: 不足期間のリスト `[(start1, end1), (start2, end2), ...]`
- **処理内容**:
  1. 既存データが空の場合 → 全期間を取得対象とする
  2. 要求開始日 < 既存データ開始日 → 開始期間が不足
  3. 要求終了日 > 既存データ終了日 → 終了期間が不足

#### `_merge_data()`
- **目的**: 既存データと新規データをマージ
- **処理内容**:
  1. 重複データの除去
  2. 日付順でのソート
  3. データの統合

#### `get_stock_data()` (差分取得対応版)
- **処理フロー**:
  1. 既存キャッシュデータの読み込み
  2. 不足期間の特定
  3. 不足期間のデータ取得
  4. データのマージとキャッシュ保存

## メリット

### 1. 効率性の向上
- **ネットワーク負荷の軽減**: 必要なデータのみを取得
- **処理時間の短縮**: 既存データの再利用
- **API制限への配慮**: 最小限のAPI呼び出し

### 2. データの整合性
- **重複データの防止**: 自動的な重複除去
- **データの完全性**: 要求期間の完全なデータを保証
- **エラー時のフォールバック**: 新規取得失敗時は既存データを使用

### 3. 運用の柔軟性
- **段階的なデータ拡張**: 必要に応じてデータ期間を拡張
- **複数銘柄の効率的管理**: 各銘柄ごとの最適化されたキャッシュ
- **詳細なログ**: 問題の特定とデバッグが容易

## 使用例

```python
from data_loader import DataLoader

dl = DataLoader()

# 1回目の取得（全期間を取得）
data1 = dl.get_stock_data('AAPL', '2024-01-01', '2024-01-31')

# 2回目の取得（同じ期間 → キャッシュから取得）
data2 = dl.get_stock_data('AAPL', '2024-01-01', '2024-01-31')

# 3回目の取得（より長い期間 → 差分のみ取得）
data3 = dl.get_stock_data('AAPL', '2024-01-01', '2024-12-31')

# 4回目の取得（より短い期間 → キャッシュから取得）
data4 = dl.get_stock_data('AAPL', '2024-01-15', '2024-01-20')
```

## 注意事項

### 1. キャッシュファイルの管理
- キャッシュファイルは `data/cache/` ディレクトリに保存
- ファイル名形式: `{symbol}_{interval}_{start_date}_{end_date}.pkl`
- 古いキャッシュファイルは手動で削除可能

### 2. エラーハンドリング
- 新規データ取得失敗時は既存キャッシュを使用
- 完全にデータが取得できない場合は空のDataFrameを返す
- 詳細なエラーログで問題の特定が可能

### 3. パフォーマンス
- 大量の銘柄を扱う場合は、キャッシュディレクトリの容量に注意
- 長期間のデータ取得時は、複数の期間に分割して取得することを推奨

## 今後の拡張予定

1. **キャッシュ有効期限の設定**: 古いデータの自動更新
2. **データ品質チェック**: 取得データの妥当性検証
3. **並列処理**: 複数銘柄の同時取得
4. **圧縮機能**: キャッシュファイルのサイズ最適化
